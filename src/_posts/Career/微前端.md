---
layout: post
title: "ğŸš€å¾®å‰ç«¯"
date: 2021-04-13
category:  Coding 
tags:
  - ^ECMAScript 6
---
# å¾®å‰ç«¯
  æŠ€æœ¯åœˆæ˜¯æ¯”è¾ƒçˆ±ç‚’æ¦‚å¿µçš„ï¼Œ`ä¸­å°`ã€`å¾®æœåŠ¡`ã€`DDD`ä¸€æ—¶éƒ½å˜æˆæ¯”è¾ƒçƒ­é—¨çš„è¯é¢˜ï¼Œå¾®å‰ç«¯ä½œä¸ºå¾®æœåŠ¡çš„ä¸€ç§è‡ªç„¶ä¹Ÿå…ä¸äº†ä¿—ã€‚åœ¨æˆ‘çœ‹æ¥ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å¤§å¤šæ•°å…¬å¸éƒ½ç”¨ä¸ä¸Šå¾®å‰ç«¯ã€‚å½“ç„¶å¾®å‰ç«¯ä¸æ˜¯ä»€ä¹ˆæ–°æŠ€æœ¯ï¼Œåªæ˜¯ä¸ºäº†è§£å†³å®é™…é—®é¢˜çš„ä¸€ç§æ–¹æ³•ã€‚å¾®å‰ç«¯è¿™ä¸‰ä¸ªå­—å¬èµ·æ¥ä¸æ˜æ‰€ä»¥ï¼Œå®é™…ä¸Šåªæ˜¯å°†é¡¹ç›®æ‰“æ•£ï¼Œå˜æˆè‹¥å¹²å°é¡¹ç›®çš„åˆé›†ï¼Œä½¿ç”¨ä¸€ç§æ–¹æ¡ˆä½¿å¾—åœ¨å¤šä¸ªé¡¹ç›®ä¹‹å‰å¹³æ»‘åˆ‡æ¢çš„æ–¹æ³•ã€‚
## ä¸ºä»€ä¹ˆéœ€è¦å¾®å‰ç«¯
å‰é¢è¯´è¿‡ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯ä¸éœ€è¦å¾®å‰ç«¯çš„ï¼Œé€šè¿‡æ¸…æ™°çš„ç»„ä»¶åˆ’åˆ†ï¼Œéƒ¨åˆ†æƒ…å†µä¸‹ä½¿ç”¨ `iframe` åµŒå…¥å°±èƒ½è§£å†³ç»å¤§éƒ¨åˆ†é—®é¢˜ã€‚ä½†æ˜¯å¾®å‰ç«¯å¯¹ä¸‹é¢çš„é—®é¢˜è§£å†³èµ·æ¥æ›´æœ‰ä¼˜åŠ¿ï¼š

1.  è¿­ä»£æ—¥ç§¯æœˆç´¯å¯¼è‡´ç»´æŠ¤å›°éš¾
ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸè¶…é•¿çš„è½¯ä»¶ï¼Œå¿…ç„¶äº§ç”Ÿå‡ºä¸€ä¸ªä½“ç§¯åºå¤§çš„è½¯ä»¶ã€‚è½¯ä»¶ä¼šå›Šæ‹¬å„ç§äº¤é”™å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œé˜…è¯»ç»´æŠ¤èµ·æ¥ç‰¹åˆ«å›°éš¾ã€‚å‰ç«¯é¡¹ç›®ä½“ç§¯æ»‹é•¿è¿˜ä¼šä½¿ç¼–è¯‘æ—¶é—´è¶Šæ¥è¶Šé•¿ï¼Œæœ¬åœ°å¼€å‘çƒ­æ›´æ–°æ—¶ç”µè„‘åƒåŠ›ï¼Œå¡æœºã€‚
2.  è·¨å›¢é˜Ÿå¼€å‘
è‹¥åŒä¸€é¡¹ç›®äº¤ç»™å¤šä¸ªå›¢é˜ŸåŒæ—¶å¼€å‘ï¼Œç”±äºæ˜¯åŒä¸€é¡¹ç›®åŒä¸€ä»“åº“ï¼Œå›¢é˜Ÿå¼€å‘çš„èµ„æºå¹¶æ²¡æœ‰éš”ç¦»ç»å¸¸ä¼šå¯¼è‡´ä»£ç å†²çªï¼Œäº’ç›¸å½±å“ä¸šåŠ¡åŠŸèƒ½ï¼Œé€ æˆå¼€å‘é£é™©ã€‚
3.  æŠ€æœ¯æ ˆå¤šæ ·æ€§
å…¬å¸åœ¨é€æ­¥æ‰©å¤§ä¸šåŠ¡ï¼Œæ°¸è¿œæœ‰æ–°çš„ä¸šåŠ¡éœ€è¦ä¸Šçº¿ï¼Œæ°¸è¿œæœ‰æ–°çš„æŠ€æœ¯æ ˆåœ¨å°è¯•ã€‚åºå¤§çš„å•ä½“è½¯ä»¶å¾ˆéš¾åŒæ—¶è¿è¡Œå¤šä¸ªæŠ€æœ¯æ ˆï¼Œå¾ˆéš¾åœ¨ä¸šåŠ¡ä¸­å°è¯•ä½¿ç”¨æ–°çš„æŠ€æœ¯ï¼Œä¸¾æ­¥ç»´è‰°ã€‚
## æŠ€æœ¯æ–¹æ¡ˆ
1.  `iframe` åµŒå¥—å¤šä¸ªå­é¡¹ç›®
2.  `MPA` å¤šå­é¡¹ç›®ä¹‹å‰é€šè¿‡é“¾æ¥è·³è½¬
3.  æ•´åˆå¤šä¸ªå­é¡¹ç›®èµ„æºï¼Œç”±ä¸»é¡¹ç›®åŠ¨æ€å¯¼èˆªä¸åŒçš„å­é¡¹ç›®
***
è¿™é‡Œé‡ç‚¹ä»‹ç»ç¬¬ä¸‰ç§ï¼Œ æ¯”è¾ƒçŸ¥åçš„å¼€æºæ–¹æ¡ˆ`Qiankun`ã€‚
`Qiankun` ä½¿ç”¨äº† `single-SPA` çš„è·¯ç”±ç³»ç»Ÿï¼Œä¸”å®ç°äº†ä¸€ä¸ª `sandbox`ï¼Œç”¨æ¥éš”ç¦» `js` è¿è¡Œç¯å¢ƒ

***
ä»¥`Vue`ä½œä¸ºä¸»åº”ç”¨åŸºåº§æ³¨å†Œå­åº”ç”¨ç¤ºä¾‹

```js
// src/micro/index.ts
import NProgress from "nprogress";
import "nprogress/nprogress.css";
import { message } from "ant-design-vue";
// å½“å‰ç‰ˆæœ¬ qiankun å¯¹ insertBefore å¤„ç†æœ‰é—®é¢˜ï¼Œè¿™é‡Œå…ˆä½¿ç”¨ä¿®æ”¹åçš„æœ¬åœ°åŒ…  esæ–‡ä»¶å°±æ˜¯ä¸‹è½½çš„ä¿®æ”¹åçš„æœ¬åœ°åŒ…
import {
  registerMicroApps,
  addGlobalUncaughtErrorHandler,
  runAfterFirstMounted,
  start,
} from "./es";
import shared from "@/shared";

const apps = [
  /**
     * name: å¾®åº”ç”¨åç§° - å…·æœ‰å”¯ä¸€æ€§
     * entry: å¾®åº”ç”¨å…¥å£ - é€šè¿‡è¯¥åœ°å€åŠ è½½å¾®åº”ç”¨
     * container: å¾®åº”ç”¨æŒ‚è½½èŠ‚ç‚¹ - å¾®åº”ç”¨åŠ è½½å®Œæˆåå°†æŒ‚è½½åœ¨è¯¥èŠ‚ç‚¹ä¸Š
     * activeRule: å¾®åº”ç”¨è§¦å‘çš„è·¯ç”±è§„åˆ™ - è§¦å‘è·¯ç”±è§„åˆ™åå°†åŠ è½½è¯¥å¾®åº”ç”¨
     * props: ä¸»åº”ç”¨ç»™å¾®åº”ç”¨ä¼ çš„å€¼
  */
  {
    name: "ReactMicroApp",
    entry: "//localhost:10100",
    container: "#frame",
    activeRule: "/react",
    props: { shared },
  },
];

  /**
    * å‚æ•°
    * apps - Array<RegistrableApp> - å¿…é€‰ï¼Œå¾®åº”ç”¨çš„ä¸€äº›æ³¨å†Œä¿¡æ¯
    * lifeCycles - LifeCycles - å¯é€‰ï¼Œå…¨å±€çš„å¾®åº”ç”¨ç”Ÿå‘½å‘¨æœŸé’©å­
 */
registerMicroApps(apps, {
  // qiankun ç”Ÿå‘½å‘¨æœŸé’©å­ - å¾®åº”ç”¨åŠ è½½å‰
  beforeLoad: (app: any) => {
    NProgress.start();
    console.log("before load", app.name);
    return Promise.resolve();
  },
  // qiankun ç”Ÿå‘½å‘¨æœŸé’©å­ - å¾®åº”ç”¨æŒ‚è½½å
  afterMount: (app: any) => {
    NProgress.done();
    console.log("after mount", app.name);
    return Promise.resolve();
  },
});

/**
 * æ·»åŠ å…¨å±€çš„æœªæ•è·å¼‚å¸¸å¤„ç†å™¨
 */
addGlobalUncaughtErrorHandler((event: Event | string) => {
  console.error(event);
  const { message: msg } = event as any;
   // åŠ è½½å¤±è´¥æ—¶æç¤º
  if (msg && msg.includes("died in status LOADING_SOURCE_CODE")) {
    message.error("å­åº”ç”¨åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥åº”ç”¨æ˜¯å¦å¯è¿è¡Œ");
  }
});

runAfterFirstMounted(() => {
  console.log("[MainApp] first app mounted");
});
// å¯¼å‡º qiankun çš„å¯åŠ¨å‡½æ•°
export default start;


// src/micro/main.ts
import startQiankun from "./micro";

startQiankun();
```

åœ¨ä¸»åº”ç”¨æ³¨å†Œå¥½äº†å¾®åº”ç”¨åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹å¾®åº”ç”¨è¿›è¡Œä¸€ç³»åˆ—çš„é…ç½®ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨ `React` çš„å…¥å£æ–‡ä»¶ `index.js` ä¸­ï¼Œå¯¼å‡º `Qiankun` ä¸»åº”ç”¨æ‰€éœ€è¦çš„ä¸‰ä¸ªç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œä»£ç å®ç°å¦‚ä¸‹
```js
import React from "react";
import ReactDOM from "react-dom";
import "antd/dist/antd.css";

import App from "./App.jsx";
import SharedModule from "@/shared";

// window.__POWERED_BY_QIANKUN__ä¸ºtrueè¯´æ˜è¿è¡Œåœ¨ä¸»åº”ç”¨å®¹å™¨é‡Œï¼Œ ä¸ºfalseå•ç‹¬å¯åŠ¨è¿è¡Œ
if (!window.__POWERED_BY_QIANKUN__) {
  render();
}

function render(props = {}) {
  // å½“ä¼ å…¥çš„ shared ä¸ä¸ºç©ºæ—¶ï¼Œåˆ™é‡è½½å­åº”ç”¨çš„ shared
  const { shared = SharedModule.getShared() } = props;
  SharedModule.overloadShared(shared);
  
  ReactDOM.render(<App />, document.getElementById("root"));
}
/**
 * bootstrap åªä¼šåœ¨å¾®åº”ç”¨åˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹æ¬¡å¾®åº”ç”¨é‡æ–°è¿›å…¥æ—¶ä¼šç›´æ¥è°ƒç”¨ mount é’©å­ï¼Œä¸ä¼šå†é‡å¤è§¦å‘ bootstrapã€‚
 * é€šå¸¸æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›å…¨å±€å˜é‡çš„åˆå§‹åŒ–ï¼Œæ¯”å¦‚ä¸ä¼šåœ¨ unmount é˜¶æ®µè¢«é”€æ¯çš„åº”ç”¨çº§åˆ«çš„ç¼“å­˜ç­‰ã€‚
 */
export async function bootstrap() {
  console.log("react app bootstraped");
}

/**
 * åº”ç”¨æ¯æ¬¡è¿›å…¥éƒ½ä¼šè°ƒç”¨ mount æ–¹æ³•ï¼Œé€šå¸¸æˆ‘ä»¬åœ¨è¿™é‡Œè§¦å‘åº”ç”¨çš„æ¸²æŸ“æ–¹æ³•
 */
export async function mount(props) {
  console.log("reactApp mount", props);
  render(props);
}

/**
 * åº”ç”¨æ¯æ¬¡ åˆ‡å‡º/å¸è½½ ä¼šè°ƒç”¨çš„æ–¹æ³•ï¼Œé€šå¸¸åœ¨è¿™é‡Œæˆ‘ä»¬ä¼šå¸è½½å¾®åº”ç”¨çš„åº”ç”¨å®ä¾‹
 */
export async function unmount() {
  console.log("react unmount");
  ReactDOM.unmountComponentAtNode(document.getElementById("root"));
}
```
å­åº”ç”¨éœ€å¯¼å‡º `bootstrap`ã€`mount`ã€`unmount`ã€`update`ï¼ˆå¯é€‰ï¼‰ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œç”¨äºåœ¨ `Qiankun` ç”Ÿå‘½å‘¨æœŸä¸­è°ƒç”¨æ¥æŒ‚è½½å’Œå¸è½½å­åº”ç”¨ã€‚
åœ¨é…ç½®å¥½äº†å…¥å£æ–‡ä»¶ `index.js` åï¼Œæˆ‘ä»¬æ–°å»º `config-overrides.js` æ–‡ä»¶æ¥é…ç½® `webpack`ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š
```js
const path = require("path");

module.exports = {
  webpack: (config) => {
    // å¾®åº”ç”¨çš„åŒ…åï¼Œè¿™é‡Œä¸ä¸»åº”ç”¨ä¸­æ³¨å†Œçš„å¾®åº”ç”¨åç§°ä¸€è‡´
    config.output.library = `ReactMicroApp`;
    // å°†ä½ çš„ library æš´éœ²ä¸ºæ‰€æœ‰çš„æ¨¡å—å®šä¹‰ä¸‹éƒ½å¯è¿è¡Œçš„æ–¹å¼
    config.output.libraryTarget = "umd";
    // æŒ‰éœ€åŠ è½½ç›¸å…³ï¼Œè®¾ç½®ä¸º webpackJsonp_ReactMicroApp å³å¯
    config.output.jsonpFunction = `webpackJsonp_ReactMicroApp`;

    config.resolve.alias = {
      ...config.resolve.alias,
      "@": path.resolve(__dirname, "src"),
    };
    return config;
  },

  devServer: function (configFunction) {
    return function (proxy, allowedHost) {
      const config = configFunction(proxy, allowedHost);
      // å…³é—­ä¸»æœºæ£€æŸ¥ï¼Œä½¿å¾®åº”ç”¨å¯ä»¥è¢« fetch
      config.disableHostCheck = true;
      // é…ç½®è·¨åŸŸè¯·æ±‚å¤´ï¼Œè§£å†³å¼€å‘ç¯å¢ƒçš„è·¨åŸŸé—®é¢˜
      config.headers = {
        "Access-Control-Allow-Origin": "*",
      };
      // é…ç½® history æ¨¡å¼
      config.historyApiFallback = true;

      return config;
    };
  },
};
```
æˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨ä¸€ä¸‹ `output` é€‰é¡¹ï¼Œå½“æˆ‘ä»¬æŠŠ `libraryTarget` è®¾ç½®ä¸º `umd` åï¼Œæˆ‘ä»¬çš„ `library` å°±æš´éœ²ä¸ºæ‰€æœ‰çš„æ¨¡å—å®šä¹‰ä¸‹éƒ½å¯è¿è¡Œçš„æ–¹å¼äº†ï¼Œä¸»åº”ç”¨å°±å¯ä»¥è·å–åˆ°å¾®åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°äº†ã€‚
***
## Qiankunçš„æ ¸å¿ƒåŸç†
1. `Qiankun` å®ç°äº†ä¸€ä¸ª `JS sandbox`ï¼Œé¿å…å­åº”ç”¨ä¹‹é—´çš„ç¯å¢ƒæ±¡æŸ“
å®ç°é€»è¾‘ï¼š
```js 
const rawWindow = window;
const fakeWindow = Object.create(null) as Window;

const sandbox: WindowProxy = new Proxy(fakeWindow, {
    set(_: Window, p: PropertyKey, value: any): boolean {
      // çœç•¥...
    },

    get(_: Window, p: PropertyKey): any {
      // çœç•¥...
    },

    has(_: Window, p: string | number | symbol): boolean {
      return p in rawWindow;
    },
});
```
`Qiankun` é€šè¿‡ `Proxy` æ‹¦æˆªäº† `fakeWindow` å¯¹è±¡ï¼Œåœ¨ä½¿ç”¨ä»–ä»¬ç¼–å†™çš„æ’ä»¶ `import-html-entry` `load` å­åº”ç”¨ `js` æ—¶å°†å…¶ä½œä¸ºå­åº”ç”¨çš„ `window`ï¼Œå¹¶ä¸”æ¯ä¸ªå­åº”ç”¨ç”Ÿæˆçš„å¯¹è±¡éƒ½ä¸åŒã€‚è¿™æ ·ï¼Œå°±å®ç°äº†æ¯ä¸ªå­åº”ç”¨çš„ç¯å¢ƒç‹¬ç«‹ï¼Œé¿å…å˜é‡æ±¡æŸ“ã€‚
```js
// get the entry html content and script executor
const { template: appContent, execScripts, assetPublicPath } = await importEntry(entry, {
    // compose the config getTemplate function with default wrapper
    getTemplate: flow(getTemplate, getDefaultTplWrapper(appName)),
    ...settings,
});

//çœç•¥éƒ¨åˆ†ä»£ç ...

// get the lifecycle hooks from module exports
let { bootstrap: bootstrapApp, mount, unmount } = await execScripts(jsSandbox);
```
`Qiankun` é‡‡ç”¨ `HTML Entry` ä½œä¸ºèµ„æºæ³¨å…¥æ–¹å¼ï¼Œ `HTML Entry` æ–¹å¼ä¸éœ€è¦å•ç‹¬æä¾›æŒ‚è½½ç‚¹ï¼Œä¹Ÿä¸éœ€è¦å•ç‹¬å¤„ç†èµ„æºåŠ è½½çš„é—®é¢˜ï¼Œæ— è®ºæ˜¯æŒ‚è½½ç‚¹è¿˜æ˜¯èµ„æºéƒ½åœ¨ `HTML` ä¸­ï¼Œéƒ½èƒ½ä¸€æ¬¡æ€§å…¨éƒ¨è§£æåˆ°ã€‚`Qiankun` æ‹‰å–å’Œè§£æ `html` éƒ½æ˜¯ä½¿ç”¨ `import-html-entry` å®Œæˆçš„ã€‚